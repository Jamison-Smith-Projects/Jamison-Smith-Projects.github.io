#!/bin/bash
pime_version_old=$(cat "$HOME/.pimeversion")
netget() {
    url="$1"
    host=$(echo "$url" | sed -E 's_https?://([^/]+).*_\1_')
    path=$(echo "$url" | sed -E 's_https?://[^/]+(/.*)?_\1_')
    path=${path:-/}

    # Create temp files
    tmp_response=$(mktemp)
    tmp_body=$(mktemp)

    {
        echo "GET $path HTTP/1.1"
        echo "Host: $host"
        echo "User-Agent: pimenetget/1.0"
        echo "Connection: close"
        echo
    } | openssl s_client -quiet -connect "$host:443" 2>/dev/null > "$tmp_response"

    # Separate headers and body
    # Find line number where headers end
    header_end=$(grep -n -m 1 '^$' "$tmp_response" | cut -d: -f1)
    body_start=$((header_end + 1))

    # Get content length (for progress)
    content_length=$(sed -n 's/^Content-Length: //Ip' "$tmp_response" | tr -d '\r')

    # Output progress manually
    if [ -n "$content_length" ]; then
        echo "Downloading ($content_length bytes):"
    fi

    # Write body to file with manual progress bar
    dd if="$tmp_response" bs=1 skip=$(awk "BEGIN { print $(wc -c < "$tmp_response" | awk '{print $1}') - $(tail -c +$body_start "$tmp_response" | wc -c) }") 2>/dev/null |
    {
        count=0
        bar_size=50
        while IFS= read -r -n1 -d '' c || [ -n "$c" ]; do
            printf "%s" "$c" >> "$tmp_body"
            count=$((count + 1))
            if [ $((count % 1024)) -eq 0 ] && [ -n "$content_length" ]; then
                progress=$((count * bar_size / content_length))
                bar=$(printf "%-${bar_size}s" "" | tr ' ' '=' | cut -c1-$progress)
                printf "\r[%s>%*s] %d%%" "$bar" $((bar_size - progress)) "" $((count * 100 / content_length))
            fi
        done
    }

    echo ""
    cat "$tmp_body"

    # Cleanup
    rm -f "$tmp_response" "$tmp_body"
}





cd $HOME/
mkdir .pimeupdater
cd .pimeupdater
netget https://jamisonsmith.is-a.dev/scripts/pime-version > pime-version
pime_version_new=$(cat pime-version)
if [ "$pime_version_new" = "$pime_version_old" ]; then 
    echo "No update needed. $pime_version_old"
    rm -rf ./pime-version
    cd ..
    rm -rf .pimeupdater
    exit 0
fi
rm -rf $HOME/.pimeversion
cp pime-version $HOME/.pimeversion
netget https://jamisonsmith.is-a.dev/scripts/pime > pime-update
sudo cp ./pime-update /usr/local/bin/pime
rm -rf ./pime-version
echo "Updated maybe successfully, try pime --help to see the new version"
cd ..
rm -rf .pimeupdater