#!/bin/bash
pime_version_old=$(cat "$HOME/.pimeversion")
netget() {
    url="$1"
    host=$(echo "$url" | sed -E 's_https?://([^/]+).*_\1_')
    path=$(echo "$url" | sed -E 's_https?://[^/]+(/.*)?_\1_')
    path=${path:-/}

    {
        echo "GET $path HTTP/1.1"
        echo "Host: $host"
        echo "User-Agent: pimenetget/1.0"
        echo "Connection: close"
        echo
    } | openssl s_client -quiet -connect "$host:443" 2>/dev/null |
        awk 'BEGIN {header=1} /^\r?$/ {header=0; next} !header'
}



cd $HOME/
mkdir .pimeupdater
cd .pimeupdater
netget https://jamisonsmith.is-a.dev/scripts/pime-version > pime-version
pime_version_new=$(cat pime-version)
if [ "$pime_version_new" = "$pime_version_old" ]; then 
    echo "No update needed. $pime_version_old"
    rm -rf ./pime-version
    cd ..
    rm -rf .pimeupdater
    exit 0
fi
rm -rf $HOME/.pimeversion
cp pime-version $HOME/.pimeversion
netget https://jamisonsmith.is-a.dev/scripts/pime > pime-update
sudo cp ./pime-update /usr/local/bin/pime
rm -rf ./pime-version
echo "Updated maybe successfully, try pime --help to see the new version"
cd ..
rm -rf .pimeupdater