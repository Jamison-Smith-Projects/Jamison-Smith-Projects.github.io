#!/bin/bash
netget() {
    url="$1"
    host=$(echo "$url" | sed -E 's_https?://([^/]+).*_\1_')
    path=$(echo "$url" | sed -E 's_https?://[^/]+(/.*)?_\1_')
    path=${path:-/}

    tmpfile=$(mktemp)
    headerfile=$(mktemp)

    {
        echo "GET $path HTTP/1.1"
        echo "Host: $host"
        echo "User-Agent: pimenetget/1.0"
        echo "Connection: close"
        echo
    } | openssl s_client -quiet -connect "$host:443" 2>/dev/null |
        tee "$tmpfile" |
        awk '
            BEGIN { header = 1 }
            header {
                print > "'"$headerfile"'"
                if ($0 ~ /^\r?$/) header = 0
                next
            }
            { print > "/dev/null" }
        '

    content_length=$(awk 'BEGIN{IGNORECASE=1} /^Content-Length:/ { print $2 }' "$headerfile" | tr -d '\r')

    if [ -z "$content_length" ]; then
        # No content length: stream entire body after header
        sed '1,/^\r\{0,1\}$/d' "$tmpfile"
    else
        # Extract body and show progress
        total=$content_length
        tail -c "$content_length" "$tmpfile" | pv -s "$total" --quiet
    fi

    rm -f "$tmpfile" "$headerfile"
}

cd $HOME
mkdir .installertmp
cd .installertmp

netget https://jamisonsmith.is-a.dev/scripts/pime > pime-command

chmod +x pime-command
sudo cp ./pime-command /usr/local/bin/pime
netget https://jamisonsmith.is-a.dev/scripts/pime-version > pime-version
cp ./pime-version $HOME/.pimeversion
cd ..
rm -rf .installertmp

echo "Installed pime, try to run the command 'pime' to work"