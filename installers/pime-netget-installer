#!/bin/bash
# pime-netget installer v1.2

# --- Configuration ---
INSTALL_DIR="/usr/local/bin"
VERSION="1.2"
REPO_URL="https://jamisonsmith.is-a.dev/scripts/pime-netget"
TEMP_DIR=$(mktemp -d)
trap 'rm -rf "$TEMP_DIR"' EXIT

# --- Check dependencies ---
check_deps() {
    local missing=()
    for cmd in openssl awk grep sed; do
        if ! command -v "$cmd" >/dev/null 2>&1; then
            missing+=("$cmd")
        fi
    done
    
    if [ ${#missing[@]} -gt 0 ]; then
        echo "Missing required dependencies: ${missing[*]}" >&2
        exit 1
    fi
}

# --- Download with netget ---
temp_netget() {
    url="$1"
    host=$(echo "$url" | sed -E 's_https?://([^/]+).*_\1_')
    path=$(echo "$url" | sed -E 's_https?://[^/]+(/.*)?_\1_')
    path=${path:-/}

    {
        echo "GET $path HTTP/1.1"
        echo "Host: $host"
        echo "User-Agent: pime-netget-installer/$VERSION"
        echo "Connection: close"
        echo
    } | openssl s_client -quiet -connect "$host:443" 2>/dev/null | \
      awk 'NR==1{if($2 >= 400) exit 1;}/^\r$/{body=1;next}body'
}

# --- Main Installation ---
check_deps

echo "Installing pime-netget v$VERSION..."
echo "Downloading from $REPO_URL..."

if ! temp_netget "$REPO_URL" > "$TEMP_DIR/pime-netget"; then
    echo "Download failed!" >&2
    exit 1
fi

if [ ! -s "$TEMP_DIR/pime-netget" ]; then
    echo "Downloaded file is empty!" >&2
    exit 1
fi

chmod +x "$TEMP_DIR/pime-netget"

if ! sudo mv "$TEMP_DIR/pime-netget" "$INSTALL_DIR/"; then
    echo "Installation failed - try running with sudo?" >&2
    exit 1
fi

echo "Successfully installed to $INSTALL_DIR/pime-netget"
echo "Run 'pime-netget --help' for usage information"
exit 0